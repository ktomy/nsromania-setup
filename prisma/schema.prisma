generator client {
  provider        = "prisma-client"
  output   = "../src/generated"
}

datasource db {
  provider = "mongodb"
}

model NSDomain {
  id                Int                   @map("_id") @db.Int @id
  active            Int                   @default(1) @db.Int
  title             String                @db.String
  domain            String                @unique @db.String
  port              Int                   @db.Int
  dbExists          Int                   @default(0) @map("db_exists") @db.Int
  apiSecret         String                @map("api_secret") @db.String
  enable            String                @db.String
  showPlugins       String                @map("show_plugins") @db.String
  mmconnectUsername String?               @map("mmconnect_username") @db.String
  mmconnectPassword String?               @map("mmconnect_password") @db.String
  mmconnectServer   String?               @default("EU") @map("mmconnect_server") @db.String
  bridgeUsername    String?               @map("bridge_username") @db.String
  bridgePassword    String?               @map("bridge_password") @db.String
  bridgeServer      String?               @default("EU") @map("bridge_server") @db.String
  created           DateTime              @default(now())
  lastUpdated       DateTime?             @default(now()) @map("last_updated")
  dbPassword        String?               @map("db_password") @db.String
  nsversion         String?               @db.String
  authUserId        String?               @map("auth_user_id") @db.ObjectId
  authUser          User?                 @relation(fields: [authUserId], references: [id])
  environments      NSDomainEnvironment[]

  @@index([authUserId], map: "ns_domain_auth_user_id_fkey")
  @@map("ns_domain")
}

model NSDomainEnvironment {
  id         Int      @id @map("_id") @db.Int
  nsDomainId Int      @map("ns_domain_id") @db.Int
  variable   String   @db.String
  value      String?  @db.String
  Domain     NSDomain @relation(fields: [nsDomainId], references: [id])

  @@index([nsDomainId], map: "ns_domain_environment_ns_domain_id_fkey")
  @@map("ns_domain_environment")
}

// model User {
//   id               String             @id @default(cuid()) @map("_id")
//   name             String?
//   username         String?            @unique
//   email            String?            @unique
//   emailVerified    DateTime?          @map("email_verified")
//   image            String?
//   createdAt        DateTime           @default(now()) @map("created_at")
//   updatedAt        DateTime           @default(now()) @updatedAt @map("updated_at")
//   loginAllowed     Int?               @map("login_allowed") @db.Int
//   role             String?            @db.String
//   accounts         Account[]
//   Authenticator    Authenticator[]
//   sessions         Session[]
//   nsDomains        NSDomain[]
//   register_request register_request[]

//   @@map("auth_user")
// }

model User {
  id            String          @id @default(auto()) @map("_id") @db.ObjectId
  name          String?
  email         String?         @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]
  // Optional for WebAuthn support
  Authenticator Authenticator[]

  // NSDomain specific things
  nsDomains     NSDomain[]
  register_request_id String?
 
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id                String  @id @default(auto()) @map("_id") @db.ObjectId
  userId            String  @db.ObjectId
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.String
  access_token      String? @db.String
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.String
  session_state     String?
 
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
 
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
 
  @@unique([provider, providerAccountId])
}
model Session {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionToken String   @unique
  userId       String   @db.ObjectId
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
 
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VerificationToken {
  id        String    @id @default(cuid()) @map("_id")
  identifier String   @map("identifier")
  token      String   @map("token")
  expires    DateTime @map("expires")

  @@unique([identifier, token])
  @@map("auth_verification_token")
}

model Authenticator {
  credentialID         String  @id @map("_id")
  userId               String  @db.ObjectId
  providerAccountId    String
  credentialPublicKey  String
  counter              Int
  credentialDeviceType String
  credentialBackedUp   Boolean
  transports           String?
 
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
 
  @@unique([userId, credentialID])
}

model register_email_validation {
  id              Int      @id @map("_id")
  email_address   String   @db.String
  validation_code String   @db.String 
  sent_at         DateTime @default(now())
}

model register_request {
  id              Int       @id @map("_id") @db.Int
  owner_name      String    @db.String
  owner_email     String    @db.String
  subdomain       String    @db.String
  api_secret      String    @db.String
  title           String?   @db.String
  data_source     String    @db.String
  dexcom_server   String?   @db.String
  dexcom_username String?   @db.String
  dexcom_password String?   @db.String
  status          String    @default("pending") @db.String
  requested_at    DateTime  @default(now())
  chnged_at       DateTime? @default(now())
  changed_by       String?
  // auth_user       User?     @relation(fields: [changed_by], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "registe_rqus_auth_user_id_fk")
  auth_user_id String? @map("registe_rqus_auth_user_id_fk")

  @@index([changed_by], map: "registe_rqus_auth_user_id_fk")
}

